
<!DOCTYPE html>
<html>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<head>
    <title>Spotify Copyright Checker - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #191414;
            color: white;
            padding: 20px;
        }
        .header {
            background: #1DB954;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        .logout-btn, .settings-btn, .bookmarked-btn {
            background: white;
            color: #1DB954;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
        }
        
        .search-box {
            background: #282828;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        input, select {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn:hover { background: #1ed760; }
        .btn-secondary {
            background: #535353;
        }
        .btn-secondary:hover { background: #636363; }
        .results {
            background: #282828;
            padding: 30px;
            border-radius: 10px;
            display: none;
        }
        .track {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .track-name { font-weight: bold; font-size: 18px; }
        .track-artist { color: #aaa; margin: 5px 0; }
        .copyright { 
            color: #1DB954; 
            font-size: 14px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }
        .license-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }
        .license-ok { background: #1e7e34; color: #fff; }
        .license-bad { background: #a71d2a; color: #fff; }
        .track { cursor: pointer; }
        .track:hover { background: #3a3a3a; }
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        .playlist-list {
            max-height: 400px;
            overflow-y: auto;
            background: #333;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .playlist-item {
            background: #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .playlist-item:hover {
            background: #555;
        }
        .playlist-info {
            flex-grow: 1;
        }
        .playlist-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .playlist-meta {
            color: #aaa;
            font-size: 14px;
        }
        .input-group {
            position: relative;
            margin-bottom: 15px;
        }
        #urlInput {
            display: block;
        }
        #playlistSelect {
            display: none;
        }
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #222;
            color: #fff;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2000;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: #1DB954; color: #191414; }
        .modal-body { padding: 20px; background: #2a2a2a; }
        .modal-close { background: transparent; border: none; font-size: 20px; cursor: pointer; color: #191414; }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .detail-box { background: #333; padding: 12px; border-radius: 8px; }
        #bookmarkBtn { position: relative; z-index: 3000; pointer-events: auto; background: red !important;}
    </style>
</head>
<body>
    <div class="header">
        <h1>üéµ Copyright Checker</h1>
        <div class="header-buttons">
            <a href="/bookmarked" class="bookmarked-btn">Saved Songs</a> 
            <a href="/setup" class="settings-btn">‚öôÔ∏è Settings</a>
            <a href="/logout"><button class="logout-btn">Logout</button></a>
        </div>
    </div>

    <div class="search-box">
        <h2>What do you want to check?</h2>
        <br>
        <select id="checkType" onchange="handleTypeChange()">
            <option value="url">Spotify URL (Album/Track/Playlist)</option>
            <option value="myplaylists">My Playlists</option>
            <option value="saved">My Saved Tracks</option>
            <option value="search">Search Tracks</option>
        </select>

        <div class="input-group">
            <input type="text" id="urlInput" placeholder="Paste Spotify URL or search query">
            <div id="playlistSelect" class="playlist-list"></div>
        </div>
        <div id="rangeInputs" style="display:none; gap: 10px;">
            <input type="number" id="rangeStart" placeholder="Start index" min="1" style="width: 49%;">
            <input type="number" id="rangeEnd" placeholder="End index" min="1" style="width: 49%;">
        </div>
        
        <button class="btn btn-secondary" id="loadPlaylistsBtn" onclick="loadMyPlaylists()" style="display: none; margin-bottom: 15px; width: 100%;">
            üìã Load My Playlists
        </button>

        <input type="number" id="limitValue" placeholder="Number of results (optional)" min="1" max="50" value="20">
        
        <button class="btn" onclick="checkCopyright()">Check Copyright</button>
    </div>

    <div class="loading" id="loading">
        <h2>‚è≥ Loading...</h2>
    </div>

    <div class="results" id="results">
        <h2 id="resultsTitle"></h2>
        <div id="trackList"></div>
    </div>

    <!-- Modal for track details -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div id="modalTitle">Track details</div>
                <button class="modal-close" onclick="closeModal(event)">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="modalContent">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <script>
        let selectedPlaylistId = null;

        function handleTypeChange() {
            const type = document.getElementById('checkType').value;
            const urlInput = document.getElementById('urlInput');
            const playlistSelect = document.getElementById('playlistSelect');
            const loadBtn = document.getElementById('loadPlaylistsBtn');
            const limitValue = document.getElementById('limitValue');
            const rangeInputs = document.getElementById('rangeInputs');

            // Reset
            urlInput.style.display = 'none';
            playlistSelect.style.display = 'none';
            loadBtn.style.display = 'none';
            selectedPlaylistId = null;
            rangeInputs.style.display = 'none';

            if (type === 'url') {
                urlInput.style.display = 'block';
                urlInput.placeholder = 'Paste Spotify URL';
                limitValue.style.display = 'none';
            } else if (type === 'myplaylists') {
                loadBtn.style.display = 'block';
                limitValue.style.display = 'none';
                rangeInputs.style.display = 'grid';
            } else if (type === 'saved') {
                limitValue.style.display = 'block';
                urlInput.style.display = 'none';
            } else if (type === 'search') {
                urlInput.style.display = 'block';
                urlInput.placeholder = 'Enter search query';
                limitValue.style.display = 'block';
            }
        }

        function loadMyPlaylists() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            fetch('/api/my-playlists')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';

                    if (data.error) {
                        alert('Error loading playlists: ' + data.error);
                        return;
                    }

                    const playlistSelect = document.getElementById('playlistSelect');
                    playlistSelect.style.display = 'block';
                    
                    let html = '<h3 style="padding: 10px; color: #1DB954;">Select a Playlist:</h3>';
                    data.playlists.forEach(playlist => {
                        html += `
                            <div class="playlist-item" onclick="selectPlaylist('${playlist.id}', '${playlist.name.replace(/'/g, "\\'")}')">
                                <div class="playlist-info">
                                    <div class="playlist-name">${playlist.name}</div>
                                    <div class="playlist-meta">${playlist.tracks} tracks ‚Ä¢ ${playlist.owner}</div>
                                </div>
                                <div>‚ñ∂</div>
                            </div>
                        `;
                    });
                    playlistSelect.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    alert('Error: ' + error);
                });
        }

        function selectPlaylist(playlistId, playlistName) {
            selectedPlaylistId = playlistId;
            
            // Highlight selected playlist
            const items = document.querySelectorAll('.playlist-item');
            items.forEach(item => item.style.background = '#444');
            event.currentTarget.style.background = '#1DB954';
            
            console.log('Selected playlist:', playlistName, playlistId);
        }

        function checkCopyright() {
            const type = document.getElementById('checkType').value;
            const input = document.getElementById('urlInput').value;
            const limit = document.getElementById('limitValue').value || 20;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            let url = '';
            if (type === 'url') {
                url = `/api/check-url?url=${encodeURIComponent(input)}`;
            } else if (type === 'myplaylists') {
                if (!selectedPlaylistId) {
                    document.getElementById('loading').style.display = 'none';
                    alert('Please select a playlist first!');
                    return;
                }
                const s = document.getElementById('rangeStart').value;
                const e = document.getElementById('rangeEnd').value;
                const range = (s && e) ? `&start=${s}&end=${e}` : '';
                url = `/api/check-playlist?playlist_id=${selectedPlaylistId}${range}`;
            } else if (type === 'saved') {
                url = `/api/saved-tracks?limit=${limit}`;
            } else if (type === 'search') {
                url = `/api/search?query=${encodeURIComponent(input)}&limit=${limit}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    
                    if (data.error) {
                        document.getElementById('resultsTitle').textContent = 'Error: ' + data.error;
                        document.getElementById('trackList').innerHTML = '';
                        return;
                    }

                    document.getElementById('resultsTitle').textContent = 
                        data.title || `Found ${data.tracks.length} tracks`;

                    let html = '';
                    data.tracks.forEach(track => {
                        html += `
                            <div class="track" onclick="openTrackDetails('${track.id}')">
                                <div class="track-name">${track.name}</div>
                                <div class="track-artist">${track.artist}</div>
                                <div style="display:flex; gap:10px; align-items:center; margin-top:8px; flex-wrap: wrap;">
                                    <span class="license-badge ${track.license?.is_free ? 'license-ok' : 'license-bad'}">
                                        ${track.license?.is_free ? '‚úì Copyright-free (heuristic)' : '‚úï Likely copyrighted'}
                                    </span>
                                    <span style="font-size:12px; color:#aaa;">Conf: ${track.license?.confidence ?? 0}</span>
                                </div>
                                <div class="copyright">
                                    ${track.copyrights.length > 0 
                                        ? track.copyrights.map(c => `${c.type}: ${c.text}`).join('<br>')
                                        : '‚ö†Ô∏è No copyright information found'}
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('trackList').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    alert('Error: ' + error);
                });
        }

        // Initialize on load
        handleTypeChange();

        function openTrackDetails(trackId) {
            if (!trackId) return;
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            const title = document.getElementById('modalTitle');
            overlay.style.display = 'flex';
            content.innerHTML = 'Loading‚Ä¶';
            fetch(`/api/track-details?track_id=${trackId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) { content.innerHTML = 'Error: ' + data.error; return; }
                    window.currentSongFullData = data;
                    title.textContent = `${data.track.name} ‚Äî ${data.track.artist}`;
                    const l = data.license;
                    const badge = `<span class="license-badge ${l.is_free ? 'license-ok' : 'license-bad'}">${l.is_free ? '‚úì Copyright-free (heuristic)' : '‚úï Likely copyrighted'}</span>`;
                    let featuresHtml = '';
                    if (data.audio_features && data.audio_features._has_data) {
                        featuresHtml = `
                            <div class="detail-box">
                                <strong>Audio Features</strong><br>
                                Tempo: ${data.audio_features.tempo} BPM<br>
                                Key: ${data.audio_features.key} ‚Ä¢ Mode: ${data.audio_features.mode}<br>
                                Danceability: ${data.audio_features.danceability}<br>
                                Energy: ${data.audio_features.energy}
                            </div>`;
                    }
                    content.innerHTML = `
                        <div style="margin-bottom: 10px; display:flex; gap:10px; align-items:center;">${badge}<span style="font-size:12px; color:#aaa;">Conf: ${l.confidence}</span>
                            <button class="bookmarkBtn" style="margin-left: auto; box-sizing: 20px; background-color: transparent; border: none; cursor: pointer;"> <i class="fas fa-bookmark" style="color: white; font-size: 24px;"></i> </button>  
                            </div>
                        <div class="details-grid">
                            <div class="detail-box">
                                <strong>Album</strong><br>${data.album.name} (${data.album.release_date})<br>Label: ${data.album.label || '‚Äî'}
                            </div>
                            <div class="detail-box">
                                <strong>Popularity</strong><br>${data.track.popularity}/100<br><strong>Explicit:</strong> ${data.track.explicit ? 'Yes' : 'No'}
                            </div>
                            ${featuresHtml}
                            <div class="detail-box">
                                <strong>Signals</strong><br>
                                Positive: ${(l.signals.positive || []).join(', ') || 'none'}<br>
                                Negative: ${(l.signals.negative || []).join(', ') || 'none'}
                            </div>
                            <div class="detail-box" style="grid-column: 1 / -1;">
                                <strong>Copyrights</strong><br>
                                ${(data.album.copyrights || []).map(c => `${c.type}: ${c.text}`).join('<br>') || 'None'}
                            </div>
                        </div>
                    `;
                })
                .catch(err => { content.innerHTML = 'Error: ' + err; });
        }

        function closeModal(e) {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        document.addEventListener("click", function (e) {
            if (e.target.closest(".bookmarkBtn")) {
                console.log("Bookmark clicked!");
                bookmarkCurrentSong();
            }
        });

        function bookmarkCurrentSong() {
            if (!window.currentSongFullData) {
                alert("No song information available.");
                return;
            }

            const payload = formatSongForDB(window.currentSongFullData);

            fetch("/api/bookmark", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    alert("Song saved!");
                } else {
                    alert("Error: " + d.error);
                }
            })
            .catch(err => alert("Error: " + err));
        }

        function formatSongForDB(data) {
            return {
                name: data.track.name,
                artist: data.track.artist,
                album: data.album.name,
                release_date: data.album.release_date,
                length: msToTime(data.track.duration_ms),
                cover_url: data.album.images?.[0]?.url || null,
                publisher: data.album.label || null,
                cr_year: data.album.release_date?.substring(0,4) || null,
                license: data.license.is_free ? "free use" : "copyrighted",
                copyright: (data.album.copyrights || [])
                    .map(c => c.text)
                    .join("; ")
            };
        }

        function msToTime(ms) {
            if (!ms) return null;
            const sec = Math.floor(ms / 1000);
            const h = String(Math.floor(sec / 3600)).padStart(2, "0");
            const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
            const s = String(sec % 60).padStart(2, "0");
            return `${h}:${m}:${s}`;
        }
    </script>
</body>
</html>

