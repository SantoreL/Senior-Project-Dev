<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/dashboard.css" />
    <link rel="stylesheet" href="/static/bookmark.css" />

    <div class="nav">
      <a href="/dashboard" class="dashboard-btn">Dashboard</a>
      <div style="row-gap: 10px; margin-left: auto; margin-right: 10px">
        <a
          id="bookmarkedBackBtn"
          href="/bookmarked"
          class="settings-btn"
          style="display: none"
          >Back</a
        >
        <a href="/setup" class="settings-btn"> Settings </a>
      </div>
    </div>
  </head>
  <body>
    <!-- check copyright expects to see these but we're not using the dropdown on this page-->
    <input type="hidden" id="checkType" value="myplaylists" />
    <input type="hidden" id="urlInput" value="" />
    <input type="hidden" id="limitValue" value="20" />
    <input type="hidden" id="rangeStart" value="" />
    <input type="hidden" id="rangeEnd" value="" />

    <div class="playlist-controls">
      <button id="createButton" onclick="createPlaylist()">
        Create New Playlist
      </button>
      <input
        id="playlistName"
        type="text"
        placeholder="New playlist name"
        style="display: none"
      />
      <button
        id="submitButton"
        onclick="submitNewPlaylist()"
        style="display: none"
      >
        Submit New Playlist
      </button>
      <button
        id="cancelCreateButton"
        onclick="cancelCreatePlaylist()"
        style="display: none"
      >
        Cancel
      </button>

      <div id="sortDropdown" style="display: none">
        <select onchange="handleSort(this.value)">
          <option value="sort_by">Sort By</option>
          <option value="release_date">Oldest Release Date</option>
          <option value="recent_release">Most Recent Release Date</option>
        </select>
      </div>
    </div>
    <div id="loading" style="display: none">Loading ...</div>

    <div id="playlistSelect" class="playlist-list" style="height: 800px"></div>

    <div class="results" id="results">
      <h2 id="resultsTitle"></h2>
      <div id="trackList"></div>
    </div>

    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <div id="modalTitle">Track details</div>
          <button class="modal-close" onclick="closeModal(event)">✕</button>
        </div>
        <div class="modal-body">
          <div id="modalContent">Loading…</div>
        </div>
      </div>
    </div>

    <div
      id="playlistModalOverlay"
      class="modal-overlay"
      style="display: none"
      onclick="closePlaylistModal(event)"
    >
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
          <div id="playlistModalTitle">Select Playlist</div>
          <button class="modal-close" onclick="closePlaylistModal()">✕</button>
        </div>
        <div class="modal-body">
          <div id="playlistModalBody">Loading…</div>
        </div>
      </div>
    </div>

    <script src="/static/playlistutil.js"></script>

    <script>
      // override the selectPlaylist function for this page bc it's not displaying the smae as the other page
      function selectPlaylist(playlistId, playlistName) {
        selectedPlaylistId = playlistId;
        document.getElementById("playlistSelect").style.display = "none";

        const sd = document.getElementById("sortDropdown");
        if (sd) sd.style.display = "block";

        const backBtn = document.getElementById("bookmarkedBackBtn");
        if (backBtn) backBtn.style.display = "inline-block";
        checkCopyright();
      }

      function showPlaylistView() {
        document.getElementById("playlistSelect").style.display = "block";
        document.getElementById("results").style.display = "none";
        selectedPlaylistId = null;
        // hide sort dropdown when returning to playlist list
        const sd = document.getElementById("sortDropdown");
        if (sd) sd.style.display = "none";
        // hide the back button when showing playlist list
        const backBtn = document.getElementById("bookmarkedBackBtn");
        if (backBtn) backBtn.style.display = "none";
      }

      function createPlaylist() {
        document.getElementById("createButton").style.display = "none";
        document.getElementById("playlistName").style.display = "block";
        document.getElementById("submitButton").style.display = "block";
        document.getElementById("cancelCreateButton").style.display = "block";
      }

      function cancelCreatePlaylist() {
        document.getElementById("playlistName").style.display = "none";
        document.getElementById("submitButton").style.display = "none";
        document.getElementById("cancelCreateButton").style.display = "none";

        document.getElementById("playlistName").value = "";
        document.getElementById("createButton").style.display = "block";
      }

      function submitNewPlaylist() {
        const name = document.getElementById("playlistName").value;

        fetch("/api/create-playlist", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            description: "Created with my app",
            public: false,
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.error) {
              alert("Error: " + data.error);
              return;
            }

            alert("Playlist created!");

            document.getElementById("playlistName").style.display = "none";
            document.getElementById("submitButton").style.display = "none";
            document.getElementById("playlistName").value = "";
            document.getElementById("createButton").style.display = "block";
            document.getElementById("cancelCreateButton").style.display = "none";
          });
        //rerender with new playlist **need to fix because it's not rerendering**
        document.addEventListener("DOMContentLoaded", () => {
          loadMyPlaylists();
        });
      }

      // sort drop down options
      function handleSort(sortType) {
        if (sortType === "release_date") {
          sortByReleaseLH();
        } else if (sortType === "recent_release") {
          sortByMostRecentRelease();
        }
      }

      function sortByReleaseLH() {
        const sortedList = [...trackList].sort(
          (a, b) => new Date(a.release_date) - new Date(b.release_date)
        );
        displaySortedTracks(sortedList);
      }

      function sortByMostRecentRelease() {
        const sortedList = [...trackList].sort(
          (a, b) => new Date(b.release_date) - new Date(a.release_date)
        );
        displaySortedTracks(sortedList);
      }

      // same as check copyright but we dont modify original playlist, just the UI
      function displaySortedTracks(sortedList) {
        renderTrackList(sortedList); // no fetch, no reloading, just re-render UI
      }

      // initialized on first load
      window.onload = function () {
        loadMyPlaylists();
      };
    </script>
  </body>
</html>
